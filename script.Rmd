---
title: "Economic and Human Consequences of Storms: An Analysis of NOAA Storm Data"
output: 
  html_document:
    keep_md: true
---

# Synopsis

Synopsis: Immediately after the title, there should be a synopsis
which describes and summarizes your analysis in at most 10 complete
sentences.

Across the United States, which types of events (as indicated in the EVTYPE variable) are most harmful with respect to population health?

Across the United States, which types of events have the greatest economic consequences?

# Data Processing

Before performing the analysis, the relevant data was loaded and preprocessed.  All code that supports this document is found at https://github.com/matthewgast/RepData-StormProject.

1.  Environment setup

Several support functions are used in this document, and are contained
in the file `script.R`.  Therefore, to set up the environment, the
support code is loaded.  The first thing performed by the code is to
load required R packages to support the analysis in the document.

```{r}
source("script.R")
loadPackages()
```

2.  Read data

With the environment set up, data is read by a support function.  The support function reads in the data, but performs no processing.

```{r}
storm.data.raw <- readData()
```

3.  Assess data quality

With a large amount of data, it is important to assess how much of the data is present.  Most of the data fields in the data set are full, with only four fields showing an NAs.

```{r}
na.list <- countNAs (storm.data.raw)
na.list
```



```{r}
names(storm.data.raw)
storm.data <- select(storm.data.raw,EVTYPE,BGN_DATE,FATALITIES,INJURIES,PROPDMG,PROPDMGEXP,CROPDMG,CROPDMGEXP)
names(storm.data) <- c("event","BGN_DATE","deaths","injuries","PROPDMG",
		  "PROPDMGEXP","CROPDMG","CROPDMGEXP")
```

We care only about 
EVTYPE
BGN_DATE (and then only because it gives us time-series data)
FATALITIES
INJURIES
PROPDMG
PROPDMGEXP
CROPDMG
CROPDMGEXP

## Fixing the date

Extract month (for seasonal analysis) and year (for time series analysis)

```{r}
storm.data$month <- as.numeric(format(as.Date(storm.data$BGN_DATE, format = "%m/%d/%Y %H:%M:%S"), "%m"))
storm.data$year <- as.numeric(format(as.Date(storm.data$BGN_DATE, format = "%m/%d/%Y %H:%M:%S"), "%Y"))
```

## Property and crop damage

Now get the right values for property and crop damage.  These are expressed as a value plus exponent (2.5 + K = 2500).  So check and see what the exponents are like.  We can see that the weird values (?,+, and -) are very small and won't throw off the analysis.

```{r}
levels(storm.data$PROPDMGEXP)
subset(storm.data,PROPDMGEXP %in% c("-","+","?"))
levels(storm.data$CROPDMGEXP)
subset(storm.data,CROPDMGEXP %in% c("-","+","?"))
```

B is billion (10^9)
h is hundreds (10^2)
m is millions (10^6)
WTF is ?, +, and -.

So we convert the exponents, and then check that they're right

```{r}
propExponent <- mapply(exponentTranslator,storm.data$PROPDMGEXP)
cropExponent <- mapply(exponentTranslator,storm.data$CROPDMGEXP)
table(storm.data$PROPDMGEXP)
table(propExponent)
table (storm.data$CROPDMGEXP)
table(cropExponent)
```

So now, put the converted exponents in, and then add in our own damage assessments.  Once bound, remove the exponent vectors (they're big)

```{r}
storm.data <- cbind(storm.data,propExponent,cropExponent)
storm.data <- mutate(storm.data,propertyDamage=PROPDMG*10^propExponent,
                     cropDamage=CROPDMG*10^cropExponent)
rm(propExponent)
rm(cropExponent)
```

Continue with data processing.  Look at what the EVTYPE field (renamed to event) has in store for us.  We have 985 event types.

```{r}
table(storm.data$event)
length(unique(storm.data$event))
storm.data$event <- toupper(storm.data$event)
```

That shrinks the number of event types.  Now we can look at the type of events, and group them into categories.

```{r}
topEvents(storm.data,10)
```

Now we want to put many types of events together.  The full source code is not used because it is repetitive, but...

There are 49 types of flood events, 98 types of thunderstorm wind event descriptions, 10 types of thunderstorms, 23 types of rain, 70 types of snow, and 53 types of wind.  Some are obviously typos, but not all.

```{r}
source("simplifyEvents.R")
storm.data <- simplifyEvents(storm.data)
```

See what this has done for the data set.

```{r}
table(storm.data$event)
length(unique(storm.data$event))
topEvents(storm.data,10)
```

Rename columns (and drop BGN_DATE and the raw damage columns)

```{r}
storm.data$event <- sapply(storm.data$event, initialCap)
storm.data <- select(storm.data,event,deaths,injuries,propertyDamage,cropDamage,month,year)
storm.data <- mutate(storm.data,
			totalDamage=propertyDamage+cropDamage,
			casualties=deaths+injuries)
storm.data = storm.data %>% select(event,year,month,propertyDamage,cropDamage,totalDamage,deaths,injuries,casualties)
```

Final bit of analysis: add together damages by event type, and then convert all the answers to billions, rounded to one decimal place.  The assumption is that all the top event types will be approximate to within an order of billions.

```{r}
effect.by.event <- aggregate (. ~ event,data=storm.data,FUN=sum)
effect.by.event <- mutate(effect.by.event,
                          propertyDamage=billions(propertyDamage),
			  cropDamage=billions(cropDamage),
			  totalDamage=billions(totalDamage))
```


# Research Question 1: Human Effect of Events 

Across the United States, which types of events (as indicated in the EVTYPE variable) are most harmful with respect to population health?

```{r}
head(arrange(effect.by.event,desc(casualties)))
head(arrange(effect.by.event,desc(deaths)))
head(arrange(effect.by.event,desc(injuries)))
```

ggplot will do a stacked bar chart, but is much more effective if you change the data from the "wide" format the "long" format with `melt()`


```{r}
casualties.by.event <- head(select(arrange(effect.by.event,desc(casualties)),event,deaths,injuries),n=10)
top10.casualty.event <- casualties.by.event$event
long.format.casualties <- melt(casualties.by.event)
casualties.g <- ggplot(long.format.casualties, aes(x = event,
			       y = value,
			       fill=variable)) +
     geom_bar(stat='identity') +
     xlab("Type of event") +
     theme(axis.text.x = element_text(angle=45, hjust=1)) +
     ylab("Casualties") +
     ggtitle("Casualties from Severe Weather") +
     scale_fill_brewer(palette="Set1",label=c("deaths","injuries")
                      ) +
     labs(fill = "Type of Casualty")

ex.tornado.casualties <- tail(head(select(arrange(effect.by.event,desc(casualties)),event,deaths,injuries),n=11),n=10)
long.format.casualties <- melt(ex.tornado.casualties)
casualties2.g <- ggplot(long.format.casualties, aes(x = event,
			       y = value,
			       fill=variable)) +
     geom_bar(stat='identity') +
     xlab("Type of event") +
     theme(axis.text.x = element_text(angle=45, hjust=1)) +
     ylab("Casualties") +
     ggtitle("Casualties from Severe Weather (non-Tornado)") +
     scale_fill_brewer(palette="Set1",label=c("deaths","injuries")
                      ) +
     labs(fill = "Type of Casualty")


monthly.top10.casualties <- filter(storm.data,event %in% top10.casualty.event)
monthly.casualties <- aggregate (. ~ event+month,data=monthly.top10.casualties,FUN=sum)
casualty.seasons.g <- ggplot(monthly.casualties,aes(x=as.factor(month),y=casualties,fill=event)) +
       geom_bar(stat='identity') + 
       theme(legend.title=element_blank()) +
       xlab("Month") +
       ylab("Casualties") +
       ggtitle("Seasonality of Top 10 Casualty Weather Events")

grid.arrange(casualties.g,casualties2.g,casualty.seasons.g,ncol=2)

```

# Research Question 2: Economic Consequences of Weather

Across the United States, which types of events have the greatest economic consequences?

```{r}
damage.by.event <- head(select(arrange(effect.by.event,desc(totalDamage)),event,cropDamage,propertyDamage),n=10)
long.format.damage <- melt(damage.by.event)
damage.g <- ggplot(long.format.damage, aes(x = event,
			       y = value,
			       fill=variable)) +
     geom_bar(stat='identity') +
     xlab("Type of event") +
     theme(axis.text.x = element_text(angle=45, hjust=1)) +
     ylab("Damage in billions of USD") +
     ggtitle("Economic Damage from Severe Weather") +
     scale_fill_brewer(palette="Set1",label=c("Crop","Property")
                      ) +
     labs(fill = "Damage Type")

top10.crop.damage <- head(select(arrange(effect.by.event,desc(cropDamage)),event,cropDamage,propertyDamage),n=10)
cropdamage.g <- ggplot(top10.crop.damage, aes(x = event,
			       y = cropDamage)) +
     geom_bar(stat='identity') +
     xlab("Type of event") +
     theme(axis.text.x = element_text(angle=45, hjust=1)) +
     ylab("Damage in billions of USD") +
     ggtitle("Top Severe Weather Causes of Crop Damage")

propdmg.by.event <- head(select(arrange(effect.by.event,desc(propertyDamage)),event,propertyDamage),n=10)
top10.propdmg.event <- propdmg.by.event$event
monthly.top10.propdmg <- filter(storm.data,event %in% top10.propdmg.event)
monthly.propdmg <- aggregate (. ~ event+month,data=monthly.top10.propdmg,FUN=sum)
property.seasons.g <- ggplot(monthly.propdmg,aes(x=as.factor(month),y=propertyDamage,fill=event)) +
       geom_bar(stat='identity') + 
       theme(legend.title=element_blank()) +
       xlab("Month") +
       ylab("Property Damage (billion USD)") +
       ggtitle("Seasonality of Top 10 Property Damage Weather Events")

cropdmg.by.event <- head(select(arrange(effect.by.event,desc(cropDamage)),event,cropDamage),n=10)
top10.cropdmg.event <- cropdmg.by.event$event
monthly.top10.cropdmg <- filter(storm.data,event %in% top10.cropdmg.event)
monthly.cropdmg <- aggregate (. ~ event+month,data=monthly.top10.cropdmg,FUN=sum)
crop.seasons.g <- ggplot(monthly.cropdmg,aes(x=as.factor(month),y=cropDamage,fill=event)) +
       geom_bar(stat='identity') + 
       theme(legend.title=element_blank()) +
       xlab("Month") +
       ylab("Crop Damage (billion USD)") +
       ggtitle("Seasonality of Top 10 Crop Damage Weather Events")

grid.arrange(damage.g,cropdamage.g,property.seasons.g,crop.seasons.g,ncol=2)


```


# Appendix: Simplifying weather types

For completeness, this includes the simplify function text.  It is large and distracts from the main flow of the paper.

TODO - figure out how to embed an existing R doc in the text.