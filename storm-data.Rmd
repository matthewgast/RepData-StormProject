---
title: 'Economic and Human Consequences of Storms: An Analysis of NOAA Storm Data'
author: "Matthew Gast"
date: "May 2015"
output:
  html_document:
    fig_caption: yes
    fig_height: 8
    fig_width: 10.5
    keep_md: yes
---

# Synopsis

Severe weather affects the population both through direct harm to individuals in the population, as well as by inflicting economic damage by harm to both property and crops.  This paper analyzes data collected by the National Oceanographic and Atmospheric Administration (NOAA) to assess the harm from severe weather in the United States.

Population harm is measured by casualties, which consist of both deaths and injuries.  The most dangerous weather event to people tornados, followed distantly by heat-related weather.  Severe weather events have seasonal patterns, with tornados doing the most harm to the population
in the spring (April), heat-related weather doing the most harm in the
summer (July), and flooding doing the most harm in the fall (October).

The economic consequences of severe weather come from both damage to
property ($392B) and damage to crops ($42B), with most of the total
economic damage coming from property damage.  The main source of crop
damage is drought, followed by floods, hurricanes, and storm surges.  Severe weather events have seasonal patterns as well, with crop damage peaking late during the growing season from June through September.
Property damage is done
mainly by floods, with significant contributions from hurricanes and
tornados.  Flood damage is concentrated in January, with tornado
damages coming in the spring (April and May), and hurricane damage in
the late summer and fall (August through October).

# Data Processing

Before performing the analysis, the relevant data was loaded and
preprocessed.  All code that supports this document may be found in the
[Github repository](https://github.com/matthewgast/RepData-StormProject) for
the project.  To improve the readability of this paper, many repetitive tasks have been turned into functions, and links to the full code will be available at GitHub.

1.  Environment setup

Several support functions are used in this document, and are contained
in the file [script.R](https://github.com/matthewgast/RepData-StormProject/blob/master/script.R).
Therefore, to set up the environment, the
support code is loaded.  This paper makes use of several R packages to support the analysis in the document.

```{r setup_environment}
source("storm-data-support-functions.R")
loadPackages()
```

2.  Read data and assess data quality

With the environment set up, data is read by a support function called `readData()`.  The
support function reads in the data, but performs no processing.  When
complete, the raw data comprises over 900,000 weather events, as seen by the `dim()` function.

```{r read_data, cache=TRUE}
storm.data.raw <- readData()
dim(storm.data.raw)
```

Now that the data is in place, look at the column names in the raw
data.

```{r show_data_names}
names(storm.data.raw)
```

For the purpose of this analysis, we care about the following fields:

- `EVTYPE`: The type of weather event, such as a drought, flood, or tornado.
- `BGN_DATE`: The date at which a particular weather event began.  This field is used to study the seasonality of weather events.
- `FATALITIES` and `INJURIES`: together, these two fields give us an indication of the total human cost of storm events.  In this analysis, they will be combined into a single "casualty" number.
- `PROPDMG` and `PROPDMGEXP`: The data set expresses property damage as the combination of a number and an exponent.  For example, US$25,000 is expressed as a value of 25 and an exponent of "K" for thousand.
- `CROPDMG` and `CROPDMGEXP`: Crop damage is expressed in the same manner as property damage.

With a large amount of data, it is important to assess how much of the
data is present.  Most of the data fields in the data set are full,
with only four fields showing an NAs, none of which matter to the
analysis.

```{r count_nas}
countNAs (storm.data.raw)
```

After deciding which fields are relevant to the analysis, select only the columns needed.  Fields that are final data are renamed
in lower case, while raw data fields that require further processing retain their
upper case names.  The event type, the number of deaths, and the
number of injuries are all in their final form.  The date field and
economic damages need further processing.

```{r select_data_fields}
storm.data <- select(storm.data.raw,EVTYPE,BGN_DATE,FATALITIES,INJURIES,PROPDMG,PROPDMGEXP,CROPDMG,CROPDMGEXP)
names(storm.data) <- c("event","BGN_DATE","deaths","injuries","PROPDMG",
		  "PROPDMGEXP","CROPDMG","CROPDMGEXP")
```

## Extracting date information

The `BGN_DATE` field consists of a day and time at which each individual
weather event began.  For the purpose of seasonal or time series
analysis, only the month and year matter, so extract them from the
data using the date manipulation fields.  The data range can be inferred by looking at the earliest and latest storm years.

```{r extract_dates}
storm.data$month <- as.numeric(format(as.Date(storm.data$BGN_DATE, format = "%m/%d/%Y %H:%M:%S"), "%m"))
storm.data$year <- as.numeric(format(as.Date(storm.data$BGN_DATE, format = "%m/%d/%Y %H:%M:%S"), "%Y"))
min(storm.data$year)
max(storm.data$year)
```

## Economic damage fields

The basic approach to assessing economic damage is to transform the
damage and exponent field into a single number.  The damages are expressed as a value plus an exponent, but the value of the exponent field is sometimes a number and sometimes a letter:

```{r print_exponent_levels}
levels(storm.data$PROPDMGEXP)
levels(storm.data$CROPDMGEXP)
```

The numerical exponent values are straightforward.  Letters have
well-understood meanings: K for thousand, M for million, and B for
billion.  However, some exponent fields are blank, have a dash, or
question mark.  To determine whether these values will throw off the
analysis, we can look and see how many times these values occur.  Only
a total of about 20 events have missing exponents, and account for
only a few thousand dollars of damage out of a total of billions.

```{r show_weird_exponents}
subset(storm.data,PROPDMGEXP %in% c("-","+","?"))
subset(storm.data,CROPDMGEXP %in% c("-","+","?"))
```

A few exponent fields are even a number.  The code book does not describe the values that should be attributed to a number, so this analysis takes the number as the exponent to a power of 10.  That is, a "3" in the exponent field means to multiply the value by 10^3.

With the help of a support function to translate an exponent character
into the power of 10 on a muliplier, we can convert the exponents into
numeric values.  By comparing the levels of the fields in the raw data
(`PROPDMGEXP` and `CROPDMGEXP`) to their translated counterparts
(`propExponent` and `cropExponent`), it is possible to get an idea of the
magnitude of the impact of severe weather.  Property damage events
with billions of dollars in damage are significantly more common than high-value crop damage events.

It is also possible to see that the original
raw data fields were translated correctly.  For example, in property
damage, there are 11,330 events with an exponent of "M", 7 events with an exponent of "m", and 4 events that use an exponent of "6".  All of these exponents translate to millions of dollars.  When translated, there are 11,341 events that have the
exponent of 10^6, which matches identically.

```{r translate_exponents, cache=TRUE}
propExponent <- mapply(exponentTranslator,storm.data$PROPDMGEXP)
cropExponent <- mapply(exponentTranslator,storm.data$CROPDMGEXP)
table(storm.data$PROPDMGEXP)
table(propExponent)
table (storm.data$CROPDMGEXP)
table(cropExponent)
```

With exponents now available in numeric form, translate the damage value and exponents into total damage fields.

```{r calculate_damage}
storm.data <- cbind(storm.data,propExponent,cropExponent)
storm.data <- mutate(storm.data,propertyDamage=PROPDMG*10^propExponent,
                     cropDamage=CROPDMG*10^cropExponent)
```

## Event simplification

The coding of events in the storm data is somewhat haphazard.  There
are 985 event types, but a casual inspection reveals many
inconsistencies.  For example, a search through the event types
determines that there are over 100,000 thunderstorm events, and those
events have 82 different text descriptions.

```{r assess_event_coding}
length(unique(storm.data$event))
name.contains.tstorm <- grepl("THUNDERSTORM",storm.data$event,ignore.case=TRUE)
sum(name.contains.tstorm)
length(unique(storm.data[name.contains.tstorm,]$event))
```

To shrink the event types to a manageable size, we begin by converting all text to upper case to avoid case mismatches between otherwise identical events.  The function `topEvents` prints out the top 10 events and the number of times they appear in the database.  Three of the top 10 events have essentially identical descriptors: "TSTM WIND", "THUNDERSTORM WIND", and "THUNDERSTORM WINDS".

```{r uppercase_event_strings}
storm.data$event <- toupper(storm.data$event)
topEvents(storm.data,10)
```

After inspecting the event names, several combinations to the data are
made.  there are over 900 event names in the database, the combination
process is quite repetitive.  In this document, it is carried out by
the function `simplifyEvents`, which is [available in the GitHub repository](https://github.com/matthewgast/RepData-StormProject/blob/master/simplifyEvents.R).
As
a result of the simplification, events related to rain and winter
weather appear in the top 10 event types, and a substantial reduction
in the number of unique event types is achieved.

```{r simplify_event_strings, cache=TRUE}
source("simplifyEvents.R")
storm.data <- simplifyEvents(storm.data)
topEvents(storm.data,10)
length(unique(storm.data$event))
```

The final step in processing event types is to reformat event types as
mixed-case names with the help of a function that rewrites even
types to have an initial capital letter in each word.

```{r prettyprint_events, cache=TRUE}
storm.data$event <- sapply(storm.data$event, initialCap)
```

## Selecting a year

Modern events are supposed to be more complete.  So let's look at that.  In the 1950s through the 1980s, the events are low.  It is only later on that the number of events keeps pace and some event types are measured.

Add a count field so that the aggregate function can sum up.

```{r count_events_by_year}
storm.data.ctr <- mutate(storm.data,count=1)
event.count <- aggregate(. ~ event+year,data=storm.data.ctr,FUN=sum)
event.count <- select(event.count,event,year,count)

total.events <- aggregate(.~event, data=event.count,FUN=sum)
top10.events <- head(arrange(total.events,desc(count)),n=10)
top10.eventnames <- top10.events$event
top10events.by.year <- filter(event.count,event %in% top10.eventnames)
```

```{r graph_events_by_year}
eventcount.base.g <- ggplot(top10events.by.year, aes(x = year,
    	       y = count,
			       fill=event)) +
     geom_bar(stat='identity') +
     xlab("year") +
     theme(axis.text.x = element_text(angle=45, hjust=1)) +
     ylab("Number of events (thousands)") +
     scale_y_continuous(labels=thousands) +
     ggtitle("Weather events per year") +
     labs(fill = "Event type")

eventcount.g <- eventcount.base.g + geom_vline(aes(xintercept=1993))

eventcount.modern.g <- eventcount.base.g + scale_x_continuous(limits=c(1992,2011))

grid.arrange(eventcount.g,eventcount.modern.g,ncol=2)

```

Based on the second graph, we keep only data from 1993 and later.  And in fact, it's still most of the data!


```{r keep_only_late_data}
storm.data <- filter(storm.data,year>=1993)
dim(storm.data)
```


## Final data processing

The final steps in data processing are to drop extraneous columns of
raw data, retaining only the event type, casualty counts, damage
information, and the extracted month and year.  Finally, the column
order is rewritten so that related columns are next to each other to
improve readability.

```{r finish_data_processing}
storm.data <- select(storm.data,event,deaths,injuries,propertyDamage,cropDamage,month,year)
storm.data <- mutate(storm.data,
			totalDamage=propertyDamage+cropDamage,
			casualties=deaths+injuries)
storm.data = storm.data %>% select(event,year,month,propertyDamage,cropDamage,totalDamage,deaths,injuries,casualties)
```

As an auxiliary bit of data, a second data frame is created that aggregates the effects of each type of weather event.  When aggregating
events, we only wish to aggregate economic damage and casualty data,
and it does not make sense to aggregate month and year numbers.

```{r calculate_effects_by_storm_type}
effect.by.event <- aggregate (cbind(propertyDamage,
		   	            cropDamage,
                                    totalDamage,
				    deaths,
				    injuries,
				    casualties) ~ event,
			       data=storm.data,
			       FUN=sum)
```


# Research Question 1: Human Effect of Events 

This section of the paper answers the question: *Across the United
States, which types of events (as indicated in the EVTYPE variable)
are most harmful with respect to population health?*

To answer this question, this section of the paper graphs casualty by storm type, but only for the top ten severe weather event types, as measured by casualties.  Tornados are dominant in this category, with almost ten times the casualties as the next highest event type.  Finally, this paper analyzes the seasonal effects of different types of weather events.

To generate the graphs for this section, the analysis begins by selecting the top ten even types by number of casualties, and then using the `melt` function to transform the "wide" data into "long" data because the long form is more suitable for plotting.  Because the tornado event type is dominant, a second plot is added to the panel, labeled "non-tornado casualties" to better illustrate the relationship of the second through tenth cause of casualties.  For readability, the casualty axis in these plots is scaled by the `thousands` function in `storm-data-support-functions.R`.


```{r casualty_graphs}
casualties.by.event <- head(select(arrange(effect.by.event,desc(casualties)),event,deaths,injuries),n=10)
top10.casualty.event <- casualties.by.event$event
long.format.casualties <- melt(casualties.by.event)
casualties.g <- ggplot(long.format.casualties, aes(x = event,
			       y = value,
			       fill=variable)) +
     geom_bar(stat='identity') +
     xlab("Type of event") +
     theme(axis.text.x = element_text(angle=45, hjust=1)) +
     ylab("Casualties (thousands)") +
     scale_y_continuous(labels=thousands) +
     ggtitle("Severe Weather Casualties") +
     scale_fill_brewer(palette="Set1",label=c("deaths","injuries")
                      ) +
     labs(fill = "Casualty Type")

nontornado.casualties <- tail(head(select(arrange(effect.by.event,desc(casualties)),event,deaths,injuries),n=10),n=9)
long.format.nontornado.casualties <- melt(nontornado.casualties)
nontornado.casualties.g <- ggplot(long.format.nontornado.casualties, aes(x = event,
  		       y = value,
			       fill=variable)) +
     geom_bar(stat='identity') +
     xlab("Type of event") +
     theme(axis.text.x = element_text(angle=45, hjust=1)) +
     ylab("Casualties (thousands)") +
     scale_y_continuous(labels=thousands) +
     ggtitle("Non-Tornado Casualties") +
     scale_fill_brewer(palette="Set1",label=c("deaths","injuries")
                      ) +
     labs(fill = "Casualty Type")
```

Many types of severe weather are seasonal.  To search out the flow of 

``` {r seasonal_casualty_graph}
monthly.top10.casualties <- filter(storm.data,event %in% top10.casualty.event)
monthly.casualties <- aggregate (. ~ event+month,data=monthly.top10.casualties,FUN=sum)
casualty.seasons.g <- ggplot(monthly.casualties,aes(
				x=reorder(month.name[month],month),
				y=casualties,
				fill=event)
			     ) +
       geom_bar(stat='identity') + 
       theme(legend.title=element_blank(),
             axis.text.x=element_text(angle=45, hjust=1)
             ) +
       xlab("Month") +
       ylab("Casualties (thousands)") +
       scale_y_continuous(labels=thousands) +
       labs(fill="Weather Type") +
       ggtitle("Weather Casualty Seasonality")
```

```{r}
grid.newpage()
pushViewport(viewport(layout=grid.layout(2,2)))
print(casualties.g,vp=viewport(layout.pos.row=1,layout.pos.col=1))
print(nontornado.casualties.g,vp=viewport(layout.pos.row=2,layout.pos.col=1))
print(casualty.seasons.g,vp=viewport(layout.pos.row=1:2,layout.pos.col=2))
```

By far, the most dangerous weather events are tornados, with nearly
ten times the casualties of the next event type, as readily seen in
the first plot in the panel below.  Fortunately, most casualties
inflicted on the population from severe weather is due to injury, and
not death.

By far the leading cause of death is tornados, followed by heat, flash
floods, lightning, and thunderstorm-related winds.  The leading causes
of injuries are tornados, thunderstorm-related winds, heat, and
flooding.  Flash floods tend to kill, while normal floods injure.
Depending on the propensity of an area to suffer from floods versus
flash floods may result in different emerency planning.

Different weather events have different seasonal patterns, as shown by
the second graph in the panel below.  Tornado activity is most
prominent in the spring.  Heat activity and flash floods occur
prominently in the summer, and floods happen mostly in the fall.
Depending on the type of severe weather expected, emergency management
agencies may need to be ready at different times of year.


# Research Question 2: Economic Consequences of Weather

*Across the United States, which types of events have the greatest
 economic consequences?*

Economic consequences are divided into damage to property and damage
to crops.  As before, total damages are plotted in the first in the
first panel.  Damage is dominated by property damage, which is far
greater than total crop damage.  The panel plots only the top ten
event types that cause economic damage.  All but one of the ten events
caused more damage to property than crops.

The leading cause of property damage is flooding, followed by
hurricanes and storm surges (often related), and tornados.  Crop
damage is due mainly to droughts and floods, with somewhat smaller
contributions from hurricanes, ice, and hail.

As with casualties, economic damage has seasonal flows.  Spring
property damage in April and May is caused by tornados, while fall
property damage in August through October is caused by the peak of
hurricane and storm surge.  Crop damage is caused mainly during the
summer, which is not surprising given the agricultural growing season.
Both droughts and floods have similar peak seasons in June through
September.

To obtain the graphs in the panel below, the raw data was summarized
by event type.  This paper combines both property and crop damage into
a total damage measurement, and produced graphs containing only the
top 10 economic damage-causing events.  Plotting both types of
economic damage on the same scale was facilitated by using the `melt`
function to reformat the data to be more compatible with plotting
functions.  Seasonal graphs were obtained by summarizing results by
month over the course of the entire data set.


```{r graph_economic_damages}
damage.by.event <- head(select(arrange(effect.by.event,desc(totalDamage)),event,cropDamage,propertyDamage),n=10)
top10.damage.events <- damage.by.event$event
long.format.damage <- melt(damage.by.event)
damage.g <- ggplot(long.format.damage, aes(x = event,
			       y = value,
			       fill=variable)) +
     geom_bar(stat='identity') +
     xlab("Type of event") +
     theme(axis.text.x = element_text(angle=45, hjust=1)) +
     ylab("US$ Damage (billions)") +
     scale_y_continuous(labels=billions) +
     ggtitle("Severe Weather Economic Damage") +
     scale_fill_brewer(palette="Set1",label=c("Crop","Property")
                      ) +
     labs(fill = "Damage Type")

monthly.top10.damage <- filter(storm.data,event %in% top10.damage.events)
monthly.damage <- aggregate (. ~event+month, data=monthly.top10.damage,FUN=sum)

monthly.propdmg <- select(monthly.damage,event,month,propertyDamage)
monthly.propdmg <- mutate(monthly.damage,damage=propertyDamage,type="Property")
monthly.propdmg <- select(monthly.propdmg,event,month,damage,type)

monthly.cropdmg <- select(monthly.damage,event,month,cropDamage)
monthly.cropdmg <- mutate(monthly.damage,damage=cropDamage,type="Crop")
monthly.cropdmg <- select(monthly.cropdmg,event,month,damage,type)

monthly.damage.table <- rbind(monthly.propdmg,monthly.cropdmg)

damage.seasons.g <- ggplot(monthly.damage.table,aes(
  			x=reorder(month.name[month],month),
				y=damage,
				fill=event)
				) +
       facet_grid(type ~ ., scales="free") +
       labs(fill="Weather Type") +
       geom_bar(stat='identity') + 
       theme(legend.title=element_blank(),
	     axis.text.x=element_text(angle=45, hjust=1)) +
       xlab("Month") +
       ylab("Property Damage (billion USD)") +
       scale_y_continuous(labels=billions) +
       ggtitle("Damage Seasonality")




grid.newpage()
pushViewport(viewport(layout=grid.layout(1,2)))
print(damage.g,vp=viewport(layout.pos.row=1,layout.pos.col=1))
print(damage.seasons.g,vp=viewport(layout.pos.row=1,layout.pos.col=2))

```


# Appendix: Further research

Other things to do:
- study average damages per event (not event type, per event; hurricanes do more damage individaully than tornadoes)
- study average human effects (again, a single hurricane does more than a tornado)
- 

For completeness, this includes the simplify function text.  It is large and distracts from the main flow of the paper.

TODO - figure out how to embed an existing R doc in the text.